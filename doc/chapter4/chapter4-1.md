# Chapter4-1: ルーティング

## ルーティング(Rooting)

### ルーティング is 何？

[Chapter2の3](https://github.com/igadaruma/study-scala/blob/main/doc/chapter2/chapter2.md#3-%E3%82%A4%E3%83%B3%E3%82%BF%E3%83%BC%E3%83%8D%E3%83%83%E3%83%88%E3%81%A8url)
ではURLについて触れ、  
[Chapter3](https://github.com/igadaruma/study-scala/blob/main/doc/chapter3/chapter3.md)
では各ステップ毎にそれぞれ別のURLをブラウザで参照いただきました。

Playを含め、Webフレームワークと呼ばれるものの多くは、言語問わず、  
`このURLに対しては、この処理(関数)を実行するよ。`といった設定が行えるようになっています。  
この手の設定のことをルーティング設定と呼んだりします。

### Playにおけるルーティング設定

Playでは`conf/routes`ファイルに対して設定を書いていきます。  
今回新たにcloneした、[study-scala-chapter4のroutesファイル](https://github.com/igadaruma/study-scala-chapter4/blob/main/conf/routes)
を見てみましょう。  
以下のような記載があると思います。

```
# URLに対する処理(関数(メソッド))の割当を行っている設定ファイルです。
GET        /        controllers.SampleController.index()
```

1行目の`#`で始まる行はコメントで、設定には影響を及ぼしません。  
2行目が設定例になっています。  
1行毎に1つのURLに対する設定を記載していく形となりますが、  
3つのセクションに分かれていまして、ざっくりとは、

```
HTTPリクエストメソッド    URLのパス部分    パッケージ名.クラス名.メソッド名
```

といった書式になっています。

### HTTPリクエストメソッド

`HTTPリクエストメソッド`という謎ワードが登場しました🤔  
ここに入る代表的に値には`GET`, `POST`, `PUT`, `PATCH`, `DELETE`といったようなものがあります。

ブラウザがサーバーに対して`データくださいな。`とリクエスト通信を行う際には、  
住所的な位置づけのURLの他にも、色々な追加の情報・データが存在します。  
例えば、Chapter1では、フォームに入力した情報(足し算する値)をサーバーに送っていました。  
このような追加情報の1つにHTTPリクエストメソッドがあります。  
(※筆者は略してHTTPメソッドと呼ぶことが多いです。)

HTTPリクエストメソッドの先の具体例は、   
慣習上おおよそ以下のような用途で使いわけられます。

|  メソッド  | 用途 | 
| ---- | ---- |
| GET | データください。 |
| POST | データ送ります。 or データ送るので新規データとして保存してください。 |
| PUT | データ送るので既存データを上書き保存してください。<br>※送るのは、対象データ一式。 |
| PATCH | データ送るので既存データを上書き保存してください。<br>※送るのは、対象データの変更箇所(差分)のみ。 |
| DELETE | データ消してください。 |

しかしながら、ブラウザがリクエストでいずれのHTTPメソッドを指定したとしても、  
実際にサーバーにこれらの用途に合う動作を強制させる力は無いので、  
あくまでも何が行われるかは、サーバー側の実装次第です。  
ただ、慣習に従ってアプリを実装しておくのを私はおすすめしています。

例えば、誰かが作ったPlayアプリケーションを私が解析する立場になったとします。  
手始めに`routes`ファイルを覗いてみたところ、以下の記述があったとします。  
(※まだ解説してない記法`(:id)部分等`がありますが今は雰囲気だけを感じてみてください・・！)

```
GET        /books        controllers.BookController.getAll()
POST       /books        controllers.BookController.create()
PUT        /books/:id    controllers.BookController.update(id)
DELETE     /books/:id    controllers.BookController.delete(id)
```

この場合、私ならば・・・  
「これはきっと`本`のデータを扱っているWebアプリで、   
1行目(GET): 本データを全部取得できるURL  
2行目(POST): 本データを追加できるURL  
3行目(PUT): 本データを更新できるURL  
4行目(DELETE): 本データを削除できるURL  
という感じなんだろう！きっとそーだ！」  
と、予想を立てます。  
そして、その予想の胸に、各メソッドを読み解いていくことになるわけですが、  
もし予想が外れていたら、あれあれ？なんか違うな？と混乱しながら読むことになりますが、    
予想通りならば、よしよし。と読み進めていく感じになるわけです。    

もしもDELETEなのにデータ作成の処理なんてしていたら、  
〇〇〇〇？〇〇〇〇！(コンプライアンス違反のため伏字)   
と、なるわけです。

つまるところ、予想通りの実装になっていたほうが、  
心理的・認知的負荷が軽減されるのはずですので、  
一般的な慣習に習うというのことも大切だと考えているわけです。

一方、先のテーブルの用途には分類しづらい機能を実装することも多々あります。  
そんな時は`GET`と`POST`から選ぶのが良いと思います。  
中でも`GET`を指定することを今は基本に考えてみて欲しいです。  
理由としては、ブラウザは特別に指定が無い限りは`GET`メソッドを指定して、  
サーバーにリクエストする仕様になっているためです。  

ちなみにもう一つの`POST`は、  
以下のようなHTMLのformタグのmethod属性に`post`が指定されていて、
```
<form method="post">
省略
</form>
```
このフォームが送信処理された(`<input type="submit" value="送信" />`押された)時等に指定されます。

その他のメソッドは、まだ紹介できてない、  
HTMLの友達である、javascriptというプログラミング言語を使い、  
Ajaxと呼ばれる方法でリクエストする場合等に指定ができるものなのですが、  
今説明するには、話が長くなりすぎるため一旦忘れてしまってください😌  
詳しくはいつか取り上げたいと考えています。ごめんね🥺

### URLをもう少し詳しく

`routes`設定の次の項目は`URLのパス部分`と表記しました。  
以下、今までに登場したURLから2つ抜粋してきました。

```
https://github.com/igadaruma/study-scala
http://localhost:9000/chapter3/0
```

URLはいくつかの部品に分解することができます。  
URLはおおよそ以下のような書式で表されています。

```
[プロトコル]://[ドメイン or IPアドレス]:[ポート番号]/[パス]?[クエリストリング]
```

`プロトコル`と`ドメイン or IPアドレス`以外は記載されない場合もあります。  
以下、省略形をいくつか提示します。

````
[プロトコル]://[ドメイン]
例：https://github.com

[プロトコル]://[ドメイン]/[パス]
例：https://github.com/igadaruma/study-scala
````

#### プロトコル？

ブラウザとサーバーの通信方式のことをプロトコルと言います。  
代表的な具体例は`http`か`https`です。  
最近は、よりプライバシーに配慮された、暗号化を行う通信方式である、  
`https`が採用される場面がほとんどです。  
※サーバー側で通信可能な方式が設定される形です。

今や、ECサイト(ネットショップ)等で`http`が指定されていた場合は、  
かなり怪しい(詐欺なのでは？)と疑った方が良いぐらいでしょう。  
一方、詐欺業者でも`https`ぐらいは普通なので、  
`https`だから安全とは考えてはいけません！

一方、開発中のWebアプリをChapter2のように動作を確認する通信の場合等は、  
開発者のみが接続を行う状況で、暗号化にあまり意味がないことも多いことから、  
手間の少ない`http`が指定されることも、まだ多いかなと思います。

`http`や`https`ってそもそも何？という疑問があるかと思いますが、  
ここでは詳しく踏み込みませんので、  
必要に応じて独自に学習をしてみて欲しいです(逃)。

結局なんだかよくわからないぞ？という感じだと思いますが、  
今は雰囲気だけでOKですので、読み進めていただけたらと思います！

#### ドメイン・IPアドレス？

Chapter2ではURLを住所のようなものと表現させていただきました。  
URLの部品でも、特に住所の性質に近いのが、このドメイン・IPアドレスです。  

まずIPアドレスからですが、  
インターネット上に公開されている各サーバーは、  
元をたどると、世界的なお偉い組織(ICANN)から分けてもらった、  
(グローバル)IPアドレスが割り当てられています。  
そしてこのお偉い組織はIPアドレスを分け与える際に、    
`このIPアドレスは、このサーバーに聞けば場所がわかる。`  
といった情報も管理してくれています。

インターネットに接続された端末は、  
行き先のIPアドレスをURLから知ると、  
(色々前後に入りますが)お偉い組織のサーバー等から情報をもらうことで、  
最終的にURLに対応したサーバーに行き着くことができるようになっています。

ちなみに、これはグローバルIPアドレスの話であり、  
対義語に当たる、プライベートIPアドレスというのが他にあり、  
例えば自宅のルーター以下の端末間同士が通信するために、各機器に割り当てられます。  
(※具体例としては自宅にあるWifi対応プリンタとそれを使うPC間の通信等がイメージしやすいかもです？)    
こういったインターネットではない、うちうちのネットワーク(Lan等と呼びます)では、  
お偉い組織は登場せず、ルータと呼ばれるようなネットワーク機器が、  
似たような仕事を担う形となっています。

TODO



